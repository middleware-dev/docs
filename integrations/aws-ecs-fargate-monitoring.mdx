---
title: "AWS ECS Fargate Monitoring"
---

ECS (Elastic Container Service) is a tool provided by AWS that enables container orchestration.
ECS tasks can be ran via EC2 instances or on AWS Fargate.
This doc will help you in monitoring your AWS ECS Fargate tasks using Middleware Agent.

### Metrics Collection
You can monitor performance metrics of your ECS Fargate tasks using Middleware Agent sidecar.
You just need to add the sidecar given below to your ECS Task `containerDefinitions`

```
{
    "name": "mw-agent",
    "image": "ghcr.io/middleware-labs/mw-host-agent:master",
    "cpu": 256,
    "portMappings": [
        {
            "name": "8006-tcp",
            "containerPort": 8006,
            "hostPort": 8006,
            "protocol": "tcp",
            "appProtocol": "http"
        }
    ],
    "essential": true,
    "environment": [
        {
            "name": "MW_API_KEY",
            "value": <Your Middleware API Key>
        },
        {
            "name": "MW_TARGET",
            "value": <Middleware Target Endpoint>
        },
    ],
    "mountPoints": [],
    "volumesFrom": [],
    "logConfiguration": {
        <Setup Log Configurations as per your requirement>
    }
}
```



### Log Monitoring
<img src="/images/integration/aws-ecs-fargate-log-monitoring.jpg" />

You can forward your ECS task logs to Middleware UI using the steps mentioned below.

#### Step 1 : Set awsfirelens as log driver for your ECS task
Add this logConfiguration into your ECS container block

```
"logConfiguration": {
    "logDriver": "awsfirelens",
    "options": {
        "Host": "127.0.0.1",
        "Name": "forward",
        "Port": "8006"
    }
}
```

#### Step 2 : Add a AWS Fluent sidecar in your ECS task
Add this sidecar container in your ECS task `containerDefinitions`
```
{
    "name": "log_router",
    "image": "amazon/aws-for-fluent-bit:stable",
    "cpu": 0,
    "portMappings": [],
    "essential": true,
    "environment": [],
    "mountPoints": [],
    "volumesFrom": [],
    "user": "0",
    "firelensConfiguration": {
        "type": "fluentbit",
        "options": {
            "enable-ecs-log-metadata": "true"
        }
    }
}
```

#### Step 3 : Add Middleware Agent sidecar in your ECS task
Add this sidecar container in your ECS task `containerDefinitions`
```
{
    "name": "mw-agent",
    "image": "ghcr.io/middleware-labs/mw-host-agent:master",
    "cpu": 256,
    "portMappings": [
        {
            "name": "8006-tcp",
            "containerPort": 8006,
            "hostPort": 8006,
            "protocol": "tcp",
            "appProtocol": "http"
        }
    ],
    "essential": true,
    "environment": [
        {
            "name": "MW_API_KEY",
            "value": <Your Middleware API Key>
        },
        {
            "name": "MW_TARGET",
            "value": <Middleware Target Endpoint>
        },
    ],
    "mountPoints": [],
    "volumesFrom": [],
    "logConfiguration": {
        <Setup Log Configurations as per your requirement>
    }
}
```


Middleware Agent sidecar will fetch these logs and will forward them to Middleware UI.

{/* #### Method 2 : Forward ECS Task Logs from CloudWatch 
AWS ECS + Fargate based apps use "awslogs" as default logging driver. Therefore, by default these logs are available at Cloudwatch.
Adding the sidecar container as mentioned above, will automatically start collecting task logs from CloudWatch.

You will need to add 2 environment variables in order to fetch logs for only a specific task 
```
"environment": [    
    {
        "name": "MW_AWS_CLOUDWATCH_LOG_GROUP_NAME",
        "value": <Cloudwatch loggroup name>
    },
    {
        "name": "MW_AWS_ECS_TASK_REGION",
        "value": <Task Region>
    },
    
],
```

<Note>
As Middleware Agent will be running as an ECS task, it will run with `ecsTaskExecutionRole`. By default this role is not permitted to read CloudWatch logs, 
Therefore, you will have to add an inline policy to allow `ecsTaskExecutionRole` to read CloudWatch logs. Alternatively, you can create a new IAM role for this usecase and then assign this role to Middleware Agent task. 
</Note> */}



